/*! lib1self-client - v0.2.12 - 2015-09-11
* http://www.1self.co
* Copyright (c) 2015 Ed Sykes; Licensed  */
!function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?module.exports=b():a.Lib1selfClient=b()}(this,function(a){"use strict";function b(a){window.latitude=a.coords.latitude,window.longitude=a.coords.longitude}function c(){navigator.geolocation?navigator.geolocation.getCurrentPosition(b):console.info("Geolocation is not supported by this browser.")}var d="http://sandbox.1self.co",e="http://sandbox.1self.co",f={dev:"http://api.1self.dev",sandbox:"http://sandbox.1self.co",production:"https://api.1self.co",staging:"http://api-staging.1self.co"},g={dev:"http://app.1self.dev",sandbox:"http://sandbox.1self.co",production:"https://app.1self.co",staging:"http://app-staging.1self.co"},h=!1,i={},j=function(a,b,c){this.streamid=function(){return a},this.readToken=function(a){return b},this.writeToken=function(a){return c}},k=function(a){return JSON.parse(window.localStorage[a]||"{}")},l=function(){var a=k("1self");return"undefined"==typeof a.events&&(a.events=[]),a}(),m=function(a,b){window.localStorage[a]=JSON.stringify(b)},n=function(a){i.streamid=a.streamid(),i.writeToken=a.writeToken(),i.readToken=a.readToken(),m("config",i)},o=function(a){return a.dateTime||(a.dateTime=(new Date).toISOString()),a.source=i.appName,a.version=i.appVersion,!a.actionTags&&ACTION_TAGS.length>0&&(a.actionTags=ACTION_TAGS),!a.objectTags&&OBJECT_TAGS.length>0&&(a.objectTags=OBJECT_TAGS),"undefined"!=typeof window.latitude&&(a.location={lat:window.latitude,"long":window.longitude}),a},p=function(a){l.events.push(a),m("1self",l)},q=function(a,b){if(!h){var c=0;if("undefined"!=typeof i.streamid){var e=d+"/v1/streams/"+i.streamid+"/events/batch",f=new XMLHttpRequest;f.open("POST",e,!0);var g={Authorization:i.writeToken,"Content-Type":"application/json"},j=Object.keys(g);j.forEach(function(a){f.setRequestHeader(a,g[a])}),f.onload=function(){4==f.readyState&&200==f.status?(l.events=l.events.slice(c),m("1self",l),a&&a()):b&&b(),h=!1},f.onerror=function(){h=!1,b&&b()},c=l.events.length,c>0&&(h=!0,f.send(JSON.stringify(l.events.slice(0,c))))}}},r=function(a){var b=1e3,c=1e3,d=null,e=b,f=function(){q(function(){clearInterval(d),e=b,d=setInterval(f,e),a.onsendsuccess&&a.onsendsuccess()},function(){clearInterval(d),e+=c,d=setInterval(f,e),a.onsenderror&&a.onsenderror()})};d=setInterval(f,b)},s=function(a,b){if("undefined"==typeof a.appName)throw new Error("appName not configured");if("undefined"==typeof a.appVersion)throw new Error("appVersion not configured");if("undefined"==typeof a.appId)throw new Error("appId not configured");if("undefined"==typeof a.appSecret)throw new Error("appSecret not configured");b&&(f[b]&&(d=f[b]),g[b]&&(e=g[b])),i=a,this.OBJECT_TAGS=[],this.ACTION_TAGS=[],this.BACKGROUND_COLOR="",this.onsendsuccess=null,this.onsenderror=null,window.localStorage["1self"]||m("1self",{events:[]});var h=k("config");return h.streamid&&(i.streamid=h.streamid),h.writeToken&&(i.writeToken=h.writeToken),h.readToken&&(i.readToken=h.readToken),window.addEventListener("load",c,!1),r(this),this};return s.prototype.on=function(a,b){"sendsuccess"===a?this.onsendsuccess=b:"senderror"===a&&(this.onsenderror=b)},s.prototype.registerStream=function(a){var b=function(a){var b=new j(a.streamid,a.readToken,a.writeToken);return b};if(!i.appId||!i.appSecret)throw new Error("Set appId and appSecret");var c=new XMLHttpRequest;return c.withCredentials=!0,c.open("POST",e+"/v1/streams",!0),c.setRequestHeader("Authorization",i.appId+":"+i.appSecret),c.onload=function(){if(4==c.readyState&&200==c.status){m("1self",{events:[]});var d=JSON.parse(c.response),e=b(d);n(e),a(null,e)}else a(new Error(c.statusText))},c.onerror=function(){a(Error("Network Error"))},c.send(),this},s.prototype.fetchStream=function(a){if("undefined"!=typeof i.streamid&&"undefined"!=typeof i.writeToken&&"undefined"!=typeof i.readToken){var b=new j(i.streamid,i.readToken,i.writeToken);n(b),a(null,b)}else this.registerStream(a);return this},s.prototype.sendEvent=function(a,b){if(!b)throw new Error("Stream needs to be specified");if("object"!=typeof a||"number"==typeof a.length)throw new Error("Event type error");return n(b),o(a),p(a),q(this.onsendsuccess,this.onsenderror,i),this},s.prototype.sendEvents=function(a,b){if(!b)throw new Error("Stream needs to be specified");if("object"!=typeof a||"undefined"==typeof a.length)throw new Error("Event type error");return n(b),a.forEach(function(a){o(a,i),p(a)}),q(this.onsendsuccess,this.onsenderror),this},s.prototype.backgroundColor=function(a){return this.BACKGROUND_COLOR=a,this},s.prototype.synchronize=function(){return q(this.onsendsuccess,this.onsenderror),this},s.prototype.pendingEventsCount=function(){return k("1self").events.length},s.prototype.objectTags=function(a){return this.OBJECT_TAGS=a,this},s.prototype.actionTags=function(a){return this.ACTION_TAGS=a,this},s.prototype.sum=function(a){return this.FUNCTION_TYPE="sum("+a+")",this.SELECTED_PROP=a,this},s.prototype.mean=function(a){return this.FUNCTION_TYPE="mean("+a+")",this.SELECTED_PROP=a,this},s.prototype.count=function(){return this.FUNCTION_TYPE="count",this},s.prototype.barChart=function(){return this.CHART_TYPE="barchart",this},s.prototype.json=function(){return this.CHART_TYPE="type/json",this},s.prototype.url=function(a){if(0===this.OBJECT_TAGS.length||0===this.ACTION_TAGS.length||!a||!this.FUNCTION_TYPE||!this.CHART_TYPE)throw new Error("Can't construct URL");n(a);var b=function(a){var b="";return a.forEach(function(a){b+=a+","}),b.slice(0,-1)},c=b(this.OBJECT_TAGS),e=b(this.ACTION_TAGS),f=d+"/v1/streams/"+a.streamid()+"/events/"+c+"/"+e+"/"+this.FUNCTION_TYPE+"/daily/"+this.CHART_TYPE+"?readToken="+a.readToken();return(void 0!==this.BACKGROUND_COLOR||""!==this.BACKGROUND_COLOR)&&(f=f+"&bgColor="+this.BACKGROUND_COLOR),f},s.prototype.formatLocalDateInISOWithOffset=function(a){if(a&&"[object Date]"===Object.prototype.toString.call(a)){var b=-a.getTimezoneOffset(),c=b>=0?"+":"-",d=function(a){var b=Math.abs(Math.floor(a));return(10>b?"0":"")+b};return a.getFullYear()+"-"+d(a.getMonth()+1)+"-"+d(a.getDate())+"T"+d(a.getHours())+":"+d(a.getMinutes())+":"+d(a.getSeconds())+c+d(b/60)+":"+d(b%60)}return""},s});